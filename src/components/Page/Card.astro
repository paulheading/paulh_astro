---
import { DateTime } from "luxon";
import { calc } from "~scripts/helpers";

import Labels from "~components/Labels.astro";
import Label from "~components/Label.astro";
import Name from "~components/Page/Card/Name.astro";
import Summary from "~components/Page/Card/Summary.astro";

import type { label } from "~types/card";

let { card, index, countTime = false } = Astro.props;

let { name, labels, dueComplete, local, start, due } = card;

let primary = labels.filter(({ color }: label) => color);

primary = primary.length ? primary[0].color : "black";

const containerProps = {
  class: "container",
  style: {},
};

if (index >= 3) containerProps.style = { display: "none" };

let nameProps = {
  href: local.url,
  name,
};

let summaryProps = {
  content: local.summary,
};

start = DateTime.fromISO(start);

due = DateTime.fromISO(due);

let length = countTime ? calc.summary_length(dueComplete, due, start) : null;
---

<script src="~scripts/components/page/card.js"></script>

<div {...containerProps}>
  <div class="label_wrap">
    <Labels>
      {
        labels.map(({ name, color }: label, index: number) => {
          const style = index == 0 ? "solid" : "outline";

          color = color ? color : primary;

          const props = {
            color,
            style,
          };

          return <Label {...props}>{name}</Label>;
        })
      }
      {
        countTime && (
          <Label color={primary} style="outline">
            {length}
          </Label>
        )
      }
    </Labels>
  </div>
  <Name {...nameProps} />
  <div class="due">
    {dueComplete ? due.toFormat("MMM yyyy") : "Ongoing"}
  </div>
  <Summary {...summaryProps} />
</div>

<style lang="scss">
  @import "~styles/mixins";

  .container {
    @include medium-down {
      padding: ($padding-row * 1.5) $padding-row;
      border-top: $border-dashed;
    }
  }

  .label_wrap {
    margin-bottom: 0.75rem;
  }

  .due {
    font-size: $font-size-summary;
    margin-bottom: 0.5rem;
    font-style: italic;
    color: $c-gray-7;
  }
</style>
